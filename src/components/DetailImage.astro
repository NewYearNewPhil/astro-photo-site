---
import { Image } from "astro:assets";
import responsiveImageSizes from "./ResponsiveImageSizes.js";

const { image, prevImage, nextImage } = Astro.props as any;

let widths = responsiveImageSizes.getResponsiveSizes({
    deviceType: "all",
    sourceImageWidth: image.data.src.width,
    widthOnPage: 100,
    mode: "standard",
    topSize: 2880,
});
---

<div
    transition:animate="fade"
    class="w-screen h-[calc(100dvh)] flex justify-center items-center"
>
    <Image
        class="max-w-screen max-h-screen w-auto h-auto absolute"
        widths={widths}
        sizes="100vw"
        src={image.data.src}
        alt=""
        loading="eager"
    />

    <div class="fixed top-4 left-4 shadow-lg idle-hidden">
        <a href="javascript:history.back()">
            <button class="btn">
                <svg
                    class="h-6 w-6 fill-current md:h-8 md:w-8"
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                >
                    <path
                        d="M15.41,16.58L10.83,12L15.41,7.41L14,6L8,12L14,18L15.41,16.58Z"
                    ></path>
                </svg>
            </button>
        </a>
    </div>
    <div class="fixed bottom-4 flex justify-center w-full">
        <div
            transition:animate="none"
            class="join bg-base-200 shadow-lg idle-hidden transition-opacity duration-200"
        >
            {
                prevImage && (
                    <a
                        id="prevImage"
                        href={`../${prevImage.slug}/`}
                        data-astro-history="replace"
                        class="join-item"
                    >
                        <button class="btn" aria-label="<">
                            <svg
                                class="h-6 w-6 fill-current md:h-8 md:w-8"
                                xmlns="http://www.w3.org/2000/svg"
                                width="24"
                                height="24"
                                viewBox="0 0 24 24"
                            >
                                <path d="M15.41,16.58L10.83,12L15.41,7.41L14,6L8,12L14,18L15.41,16.58Z" />
                            </svg>
                        </button>
                    </a>
                )
            }
            {
                nextImage && (
                    <a
                        id="nextImage"
                        href={`../${nextImage.slug}/`}
                        data-astro-history="replace"
                        class="join-item"
                    >
                        <button class="btn" aria-label=">">
                            <svg
                                class="h-6 w-6 fill-current md:h-8 md:w-8"
                                xmlns="http://www.w3.org/2000/svg"
                                width="24"
                                height="24"
                                viewBox="0 0 24 24"
                            >
                                <path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" />
                            </svg>
                        </button>
                    </a>
                )
            }
        </div>
    </div>
</div>
<script>
    import { navigate } from "astro:transitions/client";
    // changed from https://stackoverflow.com/a/23230280

    document.addEventListener("touchstart", handleTouchStart, false);
    document.addEventListener("touchmove", handleTouchMove, false);

    let xDown: number | undefined = undefined;
    let yDown: number | undefined = undefined;

    function handleTouchStart(evt: TouchEvent) {
        const firstTouch = evt.touches[0];
        xDown = firstTouch.clientX;
        yDown = firstTouch.clientY;
    }

    function handleTouchMove(evt: TouchEvent) {
        if (!xDown || !yDown) {
            return;
        }

        var xUp = evt.touches[0].clientX;
        var yUp = evt.touches[0].clientY;

        var xDiff = xDown - xUp;
        var yDiff = yDown - yUp;

        if (Math.abs(xDiff) > Math.abs(yDiff)) {
            if (xDiff > 0) {
                /* right swipe */
                const nextImage = document.querySelector(
                    "#nextImage",
                ) as HTMLAnchorElement | null;
                if (nextImage) {
                    navigate(nextImage.href, { history: "replace" });
                }
            } else {
                /* left swipe */
                const prevImage = document.querySelector(
                    "#prevImage",
                ) as HTMLAnchorElement | null;
                if (prevImage) {
                    navigate(prevImage.href, { history: "replace" });
                }
            }
        }

        xDown = undefined;
        yDown = undefined;
    }
</script>
<script>
    import init from "./IdleHidden";
    init();
</script>
